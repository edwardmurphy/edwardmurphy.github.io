<!doctype html>
<html lang="">	
<head>
	<meta charset="utf-8"/>
	<title>Fixing My Logical Volumes - ad astra per aspera</title>	
	<meta name="author" content="Edward Murphy">
	

  <meta name="description" content="I use logical volumes on my Acer notebook. My current understanding of logical volumes is that they are most often utilized when disk space is combined across multiple physical volumes, i.e. disks. I have a single SSD in my notebook, so why use logical volumes? Because I like to ...">



	<link rel="stylesheet" href="https://edwardmurphy.github.io/theme/css/main.css" type="text/css" />
		


</head>
	
<body>

    <div class="container">
	  
	  <header role="banner">
	    <div class="feeds">
	    </div>
	      <nav class="pages">
			  <a href="https://edwardmurphy.github.io/pages/about.html">About</a>
-			  <a href="https://edwardmurphy.github.io/pages/curriculum-vitae.html">Curriculum Vitae</a>
-			  <a href="https://edwardmurphy.github.io/pages/currently-reading.html">Currently Reading</a>
	      </nav>
		<a href="https://edwardmurphy.github.io" class="title">ad astra per aspera</a>
      </header>
	
	  <div class="wrapper">

		  <div role="main" class="content">
	<article class="full">
		
		<h1>Fixing My Logical Volumes</h1>
		
<div class="metadata">
  <time datetime="2016-11-04T00:00:00-07:00" pubdate>Fri 04 November 2016</time>
    <address class="vcard author">
      by <a class="url fn" href="https://edwardmurphy.github.io/author/edward-murphy.html">Edward Murphy</a>
    </address>
  in <a href="https://edwardmurphy.github.io/category/articles.html">Articles</a>
<p class="tags">tagged <a href="https://edwardmurphy.github.io/tag/logical-volumes.html">logical volumes</a>, <a href="https://edwardmurphy.github.io/tag/linux.html">linux</a></p></div>		
		<p>I use logical volumes on my Acer notebook. My current understanding of logical volumes is that they are most often utilized when disk space is combined across multiple physical volumes, i.e. disks. I have a single SSD in my notebook, so why use logical volumes? Because I like to tinker with linux distributions. I'm frequently installing new distros, resizing the space for each distro, adding shared space, uninstalling distros...tinkering. All of this is possible with a normal disk partitioning setup, but I found it to be cumbersome. After awhile unallocated partitions were squeezed between distros. Or I couldn't resize a partition easily since the next partition was not free. Sure, I could copy partitions to another disk, resize locally, then copy the saved partition. Or...I could use a tool that allows resizing on the fly. And is not "typical." Hence, my choice of logical volumes. </p>
<p>Now, logical volumes even on a single disk are not a cakewalk. For one, I've had some difficulty installing new distros directly to a new logical volume. I'm writing this while running openSUSE Leap 42.1, which I had to install to a clean partition before copying to a logical volume. Logical volumes also aren't as visible - it is possible to delete the data on a logical volume without realizing it's there (see ED ADD REFERENCE). And, if you're like me and you don't really know what you're doing and you tinker, you can wind up with a scenario like I currently have: logical volumes spread across multiple (logical) partitions within a single extended partition.</p>
<p>I probably couldn't even accurately detail how I got to my current partition setup. Just so.much.tinkering. So, it's messy. Very messy. And I want to clean it up. I want a single partition that will include all my logical volumes. Then I can tinker away cleanly.</p>
<p>First, here's a snapshot of my current partitioning:</p>
<p><img alt="Current Partition" src="https://edwardmurphy.github.io/images/currentpartition.png" /></p>
<p>Some things of note:
1. The first partition is unused and may be completely unnecessary. I use grub as my bootloader, and the files for this are located in the extended partition. I really have no idea right now if this first partition is necessary. Pretty sure Windows uses it, but I don't have Windows installed. I'm thinking this can be removed with no problem.
2. The swap partition is taking up a primary partition, and this is not necessary. I can move this to a logical partition and save a primary partition if I need it. Or I can simply use a swap file. 
3. The linux volume group is spread across multiple partitions. This is not causing any problems (in fact is one of the nice features of logical volumes) but it just looks...not right. 
4. The final partition (/dev/sda9) used to be unallocated space - this was recommended in the following article (ED ADD REFERENCE) for solid state drives. However, I needed this space to install openSUSE Leap, and did copy to the linux volume group...but look at that I'm actually still booting into this partition! Did not know that. So I have 2 copies of Leap. Sort of unnecessary, yeah? Would like to leave this space unallocated again.
5. My linux volume group currently includes 2 distros: openSUSE Leap 42.1 (already mentioned) and Linux Mint Sarah. </p>
<p>With all this in mind, in order to fix this mess, here's an outline of what I'll need to do. Note that I'm using a 120 GB Kingston SSD for all of this.
1. Make images of my current distros (for openSUSE Leap, this would be the one on /dev/sda9)
2. Wipe my entire SSD 
3. Maybe recreate the first partition again? I don't know enough about it yet to know which way to go, and it's not really taking up much space. Let's say yes to this. So, 250 MB.
4. Create a primary partition (10 GB) at the front of the drive that would allow for new distros to be installed when necessary. By leaving a partition at the front, I could also install Windows if I had to without having to move partitions again, since Windows needs to be the first OS on the disk.
5. Create a big extended partition (~98 GB) that will include:
   * swap space, and
   * a single partition (at least initially) as a volume group for all the logical volumes I want
6. Leave the final 10% of the drive (12 GB) unallocated
7. Copy images of distros to the new logical volumes (maybe...for another article).</p>
<p>This should be fun. I'll document the execution step-by-step as we go along.</p>
<h2>Imaging Current Distros</h2>
<p>There are a multitude of tools for creating images of disk partitions, but whenever possible I like to use the <strong>dd</strong> command. It's powerful, and dangerous, but it's right there - no need to install other software, figure out a new GUI, boot from a rescue USB with Clonezilla. Since I have two distros (plus another logical volume for shared files), I can image each distro while booted into the other. So, while booted into openSUSE Leap 42.1, I can image the Linux Mint distro very easily:</p>
<div class="highlight"><pre><span></span># dd if=/dev/mapper/linux-mint of=/path/to/image.img bs=4M
</pre></div>


<p>I used an external drive to save the image. The block size is...well I don't really know why I use 4M. A remnant of a quick Google search. Perhaps (likely) can be optimized. But there it is. Wait, and when complete you have an image of the distro. Simple. Just to check, we can mount the image using a loop device:</p>
<div class="highlight"><pre><span></span># losetup /dev/loop0 /path/to/image.img
# mount /dev/loop0 -o loop *mountpoint*
\$ cd *mountpoint* &amp;&amp; ls -Al
</pre></div>


<p>Quick look to see that the expected directories are there to give a little boost of confidence that all went well. Remember, the SSD will be wiped clean, so be confident as can be! Then repeat for all other logical volumes as needed. Remember to unmount and delete the loop devices:</p>
<div class="highlight"><pre><span></span># umount /dev/loop0
# losetup -d /dev/loop0
</pre></div>


<h2>Wiping SSD</h2>
<p>I followed <a href="https://wiki.archlinux.org/index.php/Solid_State_Drives/Memory_cell_clearing">this page</a> on Arch-Wiki to wipe my SSD. As disussed on the wiki page, my SSD was frozen, but after suspending the system it became unfrozen and I was able to proceed.</p>
<h2>Repartioning SSD with Parted Magic</h2>
<p>I have a multiboot USB (courtesy of <a href="https://www.pendrivelinux.com/yumi-multiboot-usb-creator/">yumi</a>) that includes a live version of Parted Magic. Booting into this I was able to use GParted to create the following partitioning scheme:
1. 20GB unformatted partition
2. 80GB partition formatted for lvm (linux logical volume manager utility)
3. 12GB unallocated space at end of drive</p>
<h2>Reinstallation of Distros</h2>
<p>So...this is where things got difficult. The Linux Mint image I created was corrupted somehow, so using <strong>dd</strong> to copy the image to the newly created lvm partition was not possible. I was not yet aware of the <strong>ddrescue</strong> utility, so I put all my effort into copying the openSUSE image first.</p>
<p>Copying the openSUSE image directly to the lvm partition did not work because the initramfs image used at boot did not include capability for logical volumes (through dracut). Thus, at boot the logical volume devices in /dev/mapper/ were not available for mounting. Because of this, I first had to copy the image to a primary partition (/dev/sda1). The file system on the first partition needed to be created first:</p>
<div class="highlight"><pre><span></span># mkfs.ext4 /dev/sda1
# dd if=/path/to/image.img of=/dev/sda1 bs=4M
</pre></div>


<p>Now, another issue comes into play. <strong>dd</strong> is a direct copy of the old distro, so the UUIDs are copied into the new partition (which was given a different UUID at creation). I don't even begin to understand it at a deeper level than what I just stated. Needless to say, it causes major issues at boot since the root partition cannot be found due to mismatch of UUID. This assumes mount points are referenced by UUID. I suppose using labels would have prevented this, but frankly I don't know. In any event, what I needed to do was give the partition a new UUID after copying the image then update /etc/fstab with the new UUID for the root partition. </p>
<div class="highlight"><pre><span></span># tune2fs -U random /dev/sda1
# blkid | grep -e &#39;/dev/sda1&#39; &gt;&gt; /etc/fstab
</pre></div>


<p>Then I opened /etc/fstab and cleaned it up to look like:
'''
UUID=uuid   /   ext4    defaults    0   1
'''</p>
<p>Finally, grub bootloader needs to be installed on the disk and the configuration updated:</p>
<div class="highlight"><pre><span></span># grub-install /dev/sda
# grub-mkconfig -o /boot/grub/grub.cfg
</pre></div>


<p>Reboot and openSUSE boots! Easy as...pause not. </p>	

	</article>

    <p>
	<a href="https://twitter.com/share" class="twitter-share-button" data-via="" data-lang="en" data-size="large" data-related="">Tweet</a>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	</p>


		  </div>	
		  
		  <div class="sidebar">
		    <div class="sidebar-container" >


  	          <nav>
	            <h2>Categories</h2>
	            <ul>
	                <li class="active"><a href="https://edwardmurphy.github.io/category/articles.html">Articles</a></li>
	                <li ><a href="https://edwardmurphy.github.io/category/past-reads.html">Past Reads</a></li>
	            </ul>
	          </nav>

	            <aside>
	            <h2>Social</h2>
			      <ul class="social">
				    <li><a href="https://github.com/edwardmurphy">GitHub</a><i></i></li>
				    <li><a href="https://www.linkedin.com/in/edward-murphy-000b002">LinkedIn</a><i></i></li>
			      </ul>
			    </aside>

	            <aside>
	              <h2>Blogroll</h2>
	              <ul>
	                  <li><a href="https://flipboard.com/@emurphy711">Flipboard</a></li>
	              </ul>
	            </aside>
	        </div>
		  </div>

	  </div>

      <footer>
		<p role="contentinfo">
		  Edward Murphy - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-sober">pelican-sober</a>.
    	</p>

	  </footer>	

	</div>
	

</body>
</html>